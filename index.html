<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Career Guide</title>
    <!-- Tailwind CSS CDN for sleek styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter and Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Keyframe Animations */
        @keyframes pulseBackground {
            0% { background-color: #f0f2f5; }
            50% { background-color: #e8ebef; }
            100% { background-color: #f0f2f5; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            min-height: 100vh; /* Ensure body takes full viewport height */
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Allow vertical scrolling */
            animation: pulseBackground 15s infinite ease-in-out; /* Subtle background animation */
        }

        .card {
            background-color: #ffffff;
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); /* Softer, more diffused shadow */
            padding: 30px;
            width: 100%; /* Full width on small screens */
            max-width: 800px; /* Max width for larger screens */
            margin-left: auto; /* Center the card */
            margin-right: auto; /* Center the card */
            transition: all 0.3s ease-in-out;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.8s ease-out forwards; /* Card entrance animation */
            opacity: 0; /* Start hidden for animation */
        }
        /* Responsive width for the card */
        @media (min-width: 768px) { /* Medium screens and up */
            .card {
                width: 75%; /* 3/4 width */
            }
        }
        @media (min-width: 1024px) { /* Large screens and up */
            .card {
                width: 66.66%; /* 2/3 width */
            }
        }

        .input-group label {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: block;
            font-size: 0.875rem;
        }
        .input-group select,
        .input-group input[type="text"],
        .input-group input[type="email"],
        .input-group input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px; /* Reverted to 8px for inputs */
            font-size: 16px;
            color: #333;
            background-color: #f9f9f9; /* Reverted to #f9f9f9 for inputs */
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .input-group select:focus,
        .input-group input[type="text"]:focus,
        .input-group input[type="email"]:focus,
        .input-group input[type="password"]:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); /* Softer focus shadow */
        }
        .submit-btn {
            background-image: linear-gradient(to right, #007aff 0%, #005bb5 100%); /* Subtle gradient */
            color: white;
            padding: 12px 25px;
            border-radius: 10px; /* Rounded buttons */
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smooth transition for all properties */
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2); /* Softer initial shadow */
            border: none; /* Remove default border */
        }
        .submit-btn:hover {
            background-image: linear-gradient(to right, #005bb5 0%, #003f80 100%); /* Darker gradient on hover */
            transform: translateY(-2px); /* More pronounced lift */
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3); /* Enhanced hover shadow */
        }
        .submit-btn:active {
            transform: translateY(1px); /* Gentle press effect */
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1); /* Reduced shadow on press */
        }

        /* Specific button styles for different actions */
        .submit-btn.green-btn {
            background-image: linear-gradient(to right, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        .submit-btn.green-btn:hover {
            background-image: linear-gradient(to right, #218838 0%, #1e7e34 100%);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .submit-btn.purple-btn {
            background-image: linear-gradient(to right, #6f42c1 0%, #563d7c 100%);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.2);
        }
        .submit-btn.purple-btn:hover {
            background-image: linear-gradient(to right, #563d7c 0%, #4a3369 100%);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        .submit-btn.red-btn {
            background-image: linear-gradient(to right, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        }
        .submit-btn.red-btn:hover {
            background-image: linear-gradient(to right, #c82333 0%, #bd2130 100%);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .submit-btn.gray-btn {
            background-image: linear-gradient(to right, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }
        .submit-btn.gray-btn:hover {
            background-image: linear-gradient(to right, #5a6268 0%, #4e555b 100%);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        .logout-btn-subtle { /* New style for logout button */
            background-color: transparent;
            color: #6c757d; /* Darker gray text */
            padding: 8px 15px;
            border: 1px solid #ced4da; /* Light gray border */
            border-radius: 8px;
            font-size: 14px; /* Smaller font size */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: none; /* No shadow */
        }
        .logout-btn-subtle:hover {
            background-color: #e9ecef; /* Light hover background */
            color: #495057; /* Slightly darker text on hover */
            border-color: #adb5bd;
            transform: translateY(-1px);
        }
        .logout-btn-subtle:active {
            transform: translateY(0);
            background-color: #dee2e6;
        }


        .job-item {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 12px; /* Consistent rounded corners */
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* For tooltip positioning */
            opacity: 0; /* Start hidden for JS animation */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow for job items */
        }
        .job-item.fade-in-slide-up {
            animation: fadeInSlideUp 0.5s ease-out forwards; /* Applied by JS with delay */
        }
        .job-item:hover {
            background-color: #eef7ff;
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Softer, larger shadow on hover */
        }
        .job-item h3 {
            font-weight: 600;
            color: #222;
            margin-bottom: 5px;
        }
        .job-item p {
            font-size: 14px;
            color: #555;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            z-index: 100;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through to elements behind it */
            left: calc(100% + 10px); /* Adjusted positioning */
            top: 50%;
            transform: translateY(-50%);
        }
        /* Tooltip visibility on hover (for desktop) and active-tooltip class (for click/touch) */
        .job-item:hover .tooltip,
        .job-item.active-tooltip .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .info-hint {
            position: absolute;
            bottom: 10px;
            right: 15px;
            color: #000080; /* Deep blue text color */
            font-size: 0.875rem; /* Slightly larger text-sm */
            font-weight: 600; /* Tailwind font-semibold */
            display: flex;
            align-items: center;
            gap: 4px; /* Tailwind space-x-1 */
            opacity: 0.9; /* Slightly faded normally */
            cursor: pointer; /* Indicate clickability */
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.7), 0 0 10px rgba(255, 255, 0, 0.5); /* Bright yellow shine effect */
            text-decoration: underline; /* Lined effect */
            transition: opacity 0.3s ease-in-out, transform 0.2s ease-in-out, color 0.2s ease-in-out, text-shadow 0.2s ease-in-out;
        }

        .job-item:hover .info-hint,
        .job-item.active-tooltip .info-hint { /* Apply hover effect on active state too */
            opacity: 1; /* Fully visible on hover */
            transform: scale(1.1); /* More pronounced scale */
            color: #0000CD; /* Slightly lighter deep blue on hover for subtle change */
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.9), 0 0 20px rgba(255, 255, 0, 0.7); /* More pronounced yellow shine */
        }

        /* Responsive adjustments for tooltip */
        @media (max-width: 640px) {
            .card {
                padding: 20px;
            }
            .input-group {
                margin-bottom: 15px;
            }
            .tooltip {
                left: 0;
                top: auto;
                bottom: 105%; /* Position above on small screens */
                transform: translateX(0);
                max-width: 100%;
            }
            .info-hint {
                bottom: 8px;
                right: 10px;
            }
        }

        /* Message box for alerts */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="antialiased">
    <div class="card">
        <!-- Initial Facade Page -->
        <div id="initialFacadePage" style="display: block;">
            <h1 class="text-3xl font-extrabold text-center text-blue-800 mb-2" style="font-family: 'Playfair Display', serif;">Opportunities waiting for you!</h1>
            <p class="text-md text-center text-blue-800 mb-6" style="font-family: 'Playfair Display', serif;">Let us first know your specialty.</p>

            <div class="space-y-6 mb-8">
                <div class="input-group">
                    <label for="initialQualificationLevel" class="text-sm font-semibold text-indigo-600">Select Qualification Level:</label>
                    <select id="initialQualificationLevel" class="block w-full">
                        <option value="">-- Select Level --</option>
                        <option value="Certificate">Certificate</option>
                        <option value="Diploma">Diploma</option>
                        <option value="Technician">Technician</option>
                        <option value="Degree">Degree</option>
                        <option value="Higher Diploma">Higher Diploma</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="initialCourseName" class="text-sm font-semibold text-indigo-600">Enter Your Course Name:</label>
                    <input type="text" id="initialCourseName" placeholder="e.g., Civil Engineering, Architecture, Quantity Surveying">
                </div>

                <button id="initialFindJobsBtn" class="submit-btn w-full">Job Matches For You</button>
            </div>

            <!-- New Contact and Movement Section for Facade Page -->
            <div class="mt-10 text-center text-gray-700">
                <p class="mb-2">Any challenge? <a href="https://wa.me/254102093870" class="text-blue-600 hover:underline font-medium">Whatsap</a> or <a href="mailto:buildersunitedke@gmail.com" class="text-blue-600 hover:underline font-medium">email now</a></p>
                <p class="mt-4 text-md font-semibold">MISSED THE DEADLINE? <a href="https://sites.google.com/d/1d-yfXv38ngv2G48bn9-cW35WulOmJJX3/p/1CL9vI1Uc9Gqs3iP1Uf8TLcDP7imaLH9H/edit" class="text-blue-600 hover:underline">Join the Movement to be always ahead of the Game</a></p>
            </div>
            <button id="goHomeBtnFacade" class="submit-btn gray-btn w-full mt-6">GO HOME</button>
        </div>

        <!-- Auth Page -->
        <div id="authPage" style="display: none;">
            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">User Account</h2>
                <!-- Updated authStatus message -->
                <div id="authStatus" class="text-center mb-4 text-gray-600">
                    First time here? <button id="authStatusSignupLink" class="text-blue-600 hover:underline font-medium">Sign up</button> first. If not proceed.
                </div>

                <div id="authForms" class="space-y-4">
                    <!-- Login Form -->
                    <div id="loginForm" class="border p-4 rounded-lg bg-white shadow-sm">
                        <h3 class="text-lg font-medium mb-2">Login</h3>
                        <div class="input-group mb-3">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="your@example.com">
                        </div>
                        <div class="input-group mb-4">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="********">
                        </div>
                        <button id="loginBtn" class="submit-btn green-btn w-full">Login</button>
                        <p class="text-center text-sm text-gray-500 mt-3">Don't have an account? <button id="showSignupBtn" class="text-blue-600 hover:underline">Sign Up</button></p>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" class="border p-4 rounded-lg bg-white shadow-sm hidden">
                        <h3 class="text-lg font-medium mb-2">Sign Up</h3>
                        <div class="input-group mb-3">
                            <label for="signupName">Name (Optional):</label>
                            <input type="text" id="signupName" placeholder="Your Name">
                        </div>
                        <div class="input-group mb-3">
                            <label for="signupEmail">Email:</label>
                            <input type="email" id="signupEmail" placeholder="your@example.com">
                        </div>
                        <div class="input-group mb-4">
                            <label for="signupPassword">Password:</label>
                            <input type="password" id="signupPassword" placeholder="Minimum 6 characters">
                        </div>
                        <button id="signupBtn" class="submit-btn purple-btn w-full">Sign Up</button>
                        <p class="text-center text-sm text-gray-500 mt-3">Already have an account? <button id="showLoginBtn" class="text-blue-600 hover:underline">Login</button></p>
                    </div>
                </div>
                <button id="backToFacadeBtn" class="submit-btn gray-btn w-full mt-4">Back to Job Search</button>
            </div>
        </div>

        <!-- Real Jobs Page -->
        <div id="realJobsPage" style="display: none;">
            <!-- Moved loggedInView here -->
            <div id="loggedInView" class="hidden text-center mb-6">
                <p class="text-lg font-medium text-gray-800 mb-4">Welcome, <span id="loggedInUserName" class="text-blue-700"></span>!</p>
                <button id="logoutBtn" class="logout-btn-subtle">Logout</button>
            </div>

            <h1 class="text-3xl font-extrabold text-center text-blue-800 mb-2" style="font-family: 'Playfair Display', serif;">Opportunities waiting for you!</h1>
            <p class="text-md text-center text-blue-800 mb-6" style="font-family: 'Playfair Display', serif;">Let us first know your specialty.</p>

            <div class="space-y-6 mb-8">
                <div class="input-group">
                    <label for="realQualificationLevel" class="text-sm font-semibold text-indigo-600">Select Qualification Level:</label>
                    <select id="realQualificationLevel" class="block w-full">
                        <option value="">-- Select Level --</option>
                        <option value="Certificate">Certificate</option>
                        <option value="Diploma">Diploma</option>
                        <option value="Technician">Technician</option>
                        <option value="Degree">Degree</option>
                        <option value="Higher Diploma">Higher Diploma</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="realCourseName" class="text-sm font-semibold text-indigo-600">Enter Your Course Name:</label>
                    <input type="text" id="realCourseName" placeholder="e.g., Civil Engineering, Architecture, Quantity Surveying">
                </div>

                <button id="realFindJobsBtn" class="submit-btn w-full">Job Matches For You</button>
            </div>

            <div id="results" class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4" style="font-family: 'Playfair Display', serif;">If missed the deadline, <a href="https://sites.google.com/d/1d-yfXv38ngv2G48bn9-cW35WulOmJJX3/p/1CL9vI1Uc9Gqs3iP1Uf8TLcDP7imaLH9H/edit" target="_blank" class="text-blue-600 hover:underline">Join</a> us for future job updates! Click details for more info</h2>
                <div id="jobList" class="space-y-4">
                    <!-- Job results will be loaded here -->
                </div>
            </div>

            <!-- New Contact and Movement Section -->
            <div class="mt-10 text-center text-gray-700">
                <p class="mb-2">Any challenge? <a href="https://wa.me/254102093870" class="text-blue-600 hover:underline font-medium">Whatsap</a> or <a href="mailto:buildersunitedke@gmail.com" class="text-blue-600 hover:underline font-medium">email now</a></p>
                <p class="mt-4 text-md font-semibold">MISSED THE DEADLINE? <a href="https://sites.google.com/d/1d-yfXv38ngv2G48bn9-cW35WulOmJJX3/p/1CL9vI1Uc9Gqs3iP1Uf8TLcDP7imaLH9H/edit" class="text-blue-600 hover:underline">Join the Movement to be always ahead of the Game</a></p>
            </div>
            <button id="goHomeBtnReal" class="submit-btn gray-btn w-full mt-6">GO HOME</button>
        </div>
    </div>

    <!-- Message Box for user feedback -->
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        /*
         * Firestore Security Rules for 'registered_users' Collection:
         *
         * To allow authenticated users to read and write to the 'registered_users' collection,
         * you need to update your Firebase Firestore Security Rules in the Firebase Console.
         *
         * Go to your Firebase project -> Firestore Database -> Rules tab.
         * Replace the existing rules with the following (or merge them appropriately):
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // Public data for all authenticated users to read and write
         * match /artifacts/{appId}/public/data/registered_users/{documentId} {
         * allow read, write: if request.auth != null;
         * }
         *
         * // Other collections (if any) can have their own rules
         * // For example, private user data:
         * // match /artifacts/{appId}/users/{userId}/{documents=**} {
         * //   allow read, write: if request.auth != null && request.auth.uid == userId;
         * // }
         * }
         * }
         *
         * This rule allows any authenticated user (including anonymously signed-in users)
         * to create and read documents in the `registered_users` collection.
         */

        // IMPORTANT: Troubleshooting Firebase Authentication Errors:
        // 1. auth/custom-token-mismatch: This error means the custom token provided by the Canvas environment
        //    (__initial_auth_token) is invalid or not generated for this specific Firebase project.
        //    This is usually an issue with the environment's setup or your Firebase project's configuration
        //    for custom tokens. It's not directly fixable in this client-side code.

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            collection,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Directly use the provided firebaseConfig
        const firebaseConfig = {
            // The API key is now intentionally left as an empty string.
            // Canvas will automatically provide the correct API key at runtime,
            // keeping it secure and out of your public code.
            apiKey: "AIzaSyD8cn6qRAcC1IBaV-SujcQo3pUB-5bONd8", 
            authDomain: "jobnavigator-49ffd.firebaseapp.com",
            projectId: "jobnavigator-49ffd",
            storageBucket: "jobnavigator-49ffd.firebasestorage.app",
            messagingSenderId: "573414546874",
            appId: "1:573414546874:web:7c94b0fc36a4823ff95183",
            measurementId: "G-Z8J2L3FV12"
        };


        let app = null; // Initialize to null
        let db = null;
        let auth = null;
        let firebaseInitialized = false; // Flag to track successful initialization
        let userId; // Will store the current user's ID

        // Variables to store data from the initial facade page
        let storedQualificationLevel = '';
        let storedCourseName = '';

        // Function to display messages to the user
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.backgroundColor = isError ? '#dc2626' : '#16a34a'; // Red for error, green for success
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // Function to show a specific page and hide others
        function showPage(pageId) {
            const pages = ['initialFacadePage', 'authPage', 'realJobsPage'];
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) {
                    page.style.display = (id === pageId) ? 'block' : 'none';
                }
            });
        }

        // Check if firebaseConfig has required properties for initialization
        const requiredConfigKeys = ["apiKey", "authDomain", "projectId"];
        const isValidConfig = requiredConfigKeys.every(key => {
            // For apiKey, we now expect it to be an empty string, as Canvas provides it.
            // So, we only check if other keys are present.
            if (key === "apiKey") return true; // Always consider apiKey valid if it's present (even if empty)
            return firebaseConfig[key];
        });

        if (!isValidConfig) {
            console.error("Firebase configuration is invalid or incomplete. Cannot initialize Firebase.");
            showMessage("Application setup incomplete. Please ensure Firebase configuration is provided.", true);
            // Disable relevant UI elements if initialization fails
            document.getElementById('initialFindJobsBtn').disabled = true; // Disable on facade
            // The auth forms and real jobs page are initially hidden anyway, so no need to disable their elements directly here.
            // They will be handled by showPage logic.
        } else {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseInitialized = true; // Set flag to true on success
                console.log("Firebase initialized successfully.");

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                onAuthStateChanged(auth, async (user) => {
                    const authStatus = document.getElementById('authStatus');
                    const loggedInUserName = document.getElementById('loggedInUserName');
                    const loggedInView = document.getElementById('loggedInView'); // Get the loggedInView

                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = `Logged in as: ${user.email}`;
                        loggedInUserName.textContent = user.displayName || user.email;
                        loggedInView.style.display = 'block'; // Show loggedInView
                        console.log("User logged in:", user.uid);
                        console.log("Current userId:", userId);

                        // If user is logged in, show the real jobs page
                        showPage('realJobsPage');
                        // Pre-fill the real jobs page inputs if data was stored from facade
                        if (realQualificationLevelSelect) realQualificationLevelSelect.value = storedQualificationLevel;
                        if (realCourseNameInput) realCourseNameInput.value = storedCourseName;

                    } else {
                        // User is not logged in. Show the initial facade page.
                        userId = null;
                        // Update authStatus message for not logged in state
                        if (authStatus) {
                            authStatus.innerHTML = `First time here? <button id="authStatusSignupLink" class="text-blue-600 hover:underline font-medium">Sign up</button> first. If not proceed.`;
                            // Re-attach event listener for the dynamically created button
                            const authStatusSignupLink = document.getElementById('authStatusSignupLink');
                            if (authStatusSignupLink) {
                                authStatusSignupLink.addEventListener('click', () => {
                                    loginForm.style.display = 'none';
                                    signupForm.style.display = 'block';
                                });
                            }
                        }
                        if (loggedInView) loggedInView.style.display = 'none'; // Hide loggedInView
                        console.log("User logged out.");
                        // Always show the initial facade page if not logged in
                        showPage('initialFacadePage');

                        // If there's an initialAuthToken, try to sign in with it, but don't force page change on failure
                        if (firebaseInitialized && auth && initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token successfully via onAuthStateChanged fallback.");
                            } catch (error) {
                                console.error("Error signing in with custom token via onAuthStateChanged fallback:", error);
                                if (error.code === 'auth/custom-token-mismatch') {
                                    showMessage("Authentication with provided token failed. Please ensure your Firebase custom token is valid and generated for this project.", true);
                                } else {
                                    showMessage(`Authentication failed: ${error.message}.`, true);
                                }
                                // User remains on initialFacadePage, can click "Find Jobs" to go to authPage
                            }
                        }
                    }
                });

            } catch (firebaseError) {
                console.error("Firebase initialization failed:", firebaseError);
                showMessage("Failed to initialize the application. Please try again later.", true);
                if (document.getElementById('initialFindJobsBtn')) document.getElementById('initialFindJobsBtn').disabled = true;
                // Display a message on the facade page itself if Firebase init fails
                const initialFacadePage = document.getElementById('initialFacadePage');
                if (initialFacadePage) {
                    initialFacadePage.innerHTML = '<p class="text-red-500 text-center">Application initialization failed. Please contact support.</p>';
                }
            }
        }

        // --- DOM Elements ---
        let initialQualificationLevelSelect;
        let initialCourseNameInput;
        let initialFindJobsBtn;

        let loginEmailInput;
        let loginPasswordInput;
        let loginBtn;
        let signupNameInput;
        let signupEmailInput;
        let signupPasswordInput;
        let signupBtn;
        let logoutBtn;
        let showSignupBtn;
        let showLoginBtn;
        let loginForm;
        let signupForm;
        let backToFacadeBtn; // New button
        let authStatusSignupLink; // New element for the dynamic link

        let realQualificationLevelSelect;
        let realCourseNameInput;
        let realFindJobsBtn;
        let jobListDiv;
        let goHomeBtnFacade; // New Go Home button for facade
        let goHomeBtnReal; // New Go Home button for real jobs page


        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements for Initial Facade Page
            initialQualificationLevelSelect = document.getElementById('initialQualificationLevel');
            initialCourseNameInput = document.getElementById('initialCourseName');
            initialFindJobsBtn = document.getElementById('initialFindJobsBtn');
            goHomeBtnFacade = document.getElementById('goHomeBtnFacade'); // Get new Go Home button

            // Assign DOM elements for Auth Page
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginBtn = document.getElementById('loginBtn');
            signupNameInput = document.getElementById('signupName');
            signupEmailInput = document.getElementById('signupEmail');
            signupPasswordInput = document.getElementById('signupPassword');
            signupBtn = document.getElementById('signupBtn');
            // logoutBtn and loggedInView are now in realJobsPage, get them there
            logoutBtn = document.getElementById('logoutBtn'); // This now points to the button on realJobsPage
            showSignupBtn = document.getElementById('showSignupBtn');
            showLoginBtn = document.getElementById('showLoginBtn');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            backToFacadeBtn = document.getElementById('backToFacadeBtn'); // Get new button
            authStatusSignupLink = document.getElementById('authStatusSignupLink');


            // Assign DOM elements for Real Jobs Page
            realQualificationLevelSelect = document.getElementById('realQualificationLevel');
            realCourseNameInput = document.getElementById('realCourseName');
            realFindJobsBtn = document.getElementById('realFindJobsBtn');
            jobListDiv = document.getElementById('jobList');
            goHomeBtnReal = document.getElementById('goHomeBtnReal'); // Get new Go Home button for real jobs page


            // Set default values for qualification and course on the initial facade
            if (initialQualificationLevelSelect) {
                initialQualificationLevelSelect.value = ""; // Removed pre-fill
            }
            if (initialCourseNameInput) {
                initialCourseNameInput.value = ""; // Removed pre-fill
            }


            // --- Event Listeners ---

            // Initial Facade Page "Find Jobs" button
            if (initialFindJobsBtn) initialFindJobsBtn.addEventListener('click', (event) => {
                event.preventDefault();
                // Store the current inputs from the facade page
                storedQualificationLevel = initialQualificationLevelSelect.value;
                storedCourseName = initialCourseNameInput.value;

                showPage('authPage'); // Go to auth page
                showMessage("Please sign up or log in to view job opportunities.", false);
            });

            // Auth Page: Show Signup/Login forms
            if (showSignupBtn) showSignupBtn.addEventListener('click', () => {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            });

            if (showLoginBtn) showLoginBtn.addEventListener('click', () => {
                signupForm.style.display = 'none';
                loginForm.style.display = 'block';
            });

            // Auth Page: Back to Facade button
            if (backToFacadeBtn) backToFacadeBtn.addEventListener('click', () => {
                showPage('initialFacadePage');
                // Optionally clear stored values if user goes back before logging in
                storedQualificationLevel = '';
                storedCourseName = '';
            });

            // Auth Page: Signup button
            if (signupBtn) signupBtn.addEventListener('click', async () => {
                if (!firebaseInitialized || !auth || !db) {
                    showMessage("Application is not fully initialized. Please try again later.", true);
                    return;
                }
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;
                const name = signupNameInput.value.trim();

                // Client-side validation
                if (!email || !password) {
                    showMessage("Please enter both email and password for signup.", true);
                    return;
                }
                if (!/\S+@\S+\.\S+/.test(email)) {
                    showMessage("Please enter a valid email address.", true);
                    return;
                }
                if (password.length < 6) {
                    showMessage("Password should be at least 6 characters.", true);
                    return;
                }

                // Show loading state
                signupBtn.textContent = 'Signing Up...';
                signupBtn.disabled = true;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Store user's email and name in Firestore for "footprints"
                    const registeredUsersCollection = collection(db, `artifacts/${appId}/public/data/registered_users`);
                    await setDoc(doc(registeredUsersCollection, user.uid), {
                        email: user.email,
                        name: name || "Anonymous User",
                        registeredAt: new Date().toISOString()
                    });
                    showMessage("Account created successfully! You are now logged in.");
                    // onAuthStateChanged will handle the page transition to realJobsPage
                } catch (error) {
                    console.error("Signup error:", error);
                    let errorMessage = "Signup failed. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "This email is already in use. Please try logging in or use a different email.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format. Please enter a valid email address.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password is too weak. Please choose a stronger password (at least 6 characters).";
                    }
                    showMessage(errorMessage, true);
                } finally {
                    // Hide loading state
                    signupBtn.textContent = 'Sign Up';
                    signupBtn.disabled = false;
                }
            });

            // Auth Page: Login button
            if (loginBtn) loginBtn.addEventListener('click', async () => {
                if (!firebaseInitialized || !auth) {
                    showMessage("Application is not fully initialized. Please try again later.", true);
                    return;
                }
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;

                // Client-side validation
                if (!email || !password) {
                    showMessage("Please enter both email and password for login.", true);
                    return;
                }
                if (!/\S+@\S+\.\S+/.test(email)) {
                    showMessage("Please enter a valid email address.", true);
                    return;
                }

                // Show loading state
                loginBtn.textContent = 'Logging In...';
                loginBtn.disabled = true;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Logged in successfully!");
                    // onAuthStateChanged will handle the page transition to realJobsPage
                } catch (error) {
                    console.error("Login error:", error);
                    let errorMessage = "Login failed. Please check your credentials and try again.";
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        errorMessage = "Invalid email or password. Please check your credentials.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format. Please enter a valid email address.";
                    }
                    showMessage(errorMessage, true);
                } finally {
                    // Hide loading state
                    loginBtn.textContent = 'Login';
                    loginBtn.disabled = false;
                }
            });

            // Logout button (on Real Jobs Page)
            if (logoutBtn) logoutBtn.addEventListener('click', async () => {
                if (!firebaseInitialized || !auth) {
                    showMessage("Application is not fully initialized. Please try again later.", true);
                    return;
                }
                // Show loading state
                logoutBtn.textContent = 'Logging Out...';
                logoutBtn.disabled = true;

                try {
                    await signOut(auth);
                    showMessage("Logged out successfully.");
                    // onAuthStateChanged will handle the page transition back to initialFacadePage
                } catch (error) {
                    console.error("Logout error:", error);
                    showMessage(`Logout failed: ${error.message}`, true);
                } finally {
                    // Hide loading state (will be hidden anyway by page change, but good practice)
                    logoutBtn.textContent = 'Logout';
                    logoutBtn.disabled = false;
                }
            });

            // Real Jobs Page "Find Jobs" button (this one actually finds jobs)
            if (realFindJobsBtn) realFindJobsBtn.addEventListener('click', () => {
                // Show loading state
                realFindJobsBtn.textContent = 'Finding Jobs...';
                realFindJobsBtn.disabled = true;
                try {
                    findJobs(); // Call the actual job finding function
                } finally {
                    // Hide loading state
                    realFindJobsBtn.textContent = 'Job Matches For You';
                    realFindJobsBtn.disabled = false;
                }
            });

            // Go Home button for Facade Page
            if (goHomeBtnFacade) goHomeBtnFacade.addEventListener('click', () => {
                window.location.href = "https://sites.google.com/d/1d-yfXv38ngv2G48bn9-cW35WulOmJJX3/p/1CL9vI1Uc9Gqs3iP1Uf8TLcDP7imaLH9H/edit";
            });

            // Go Home button for Real Jobs Page
            if (goHomeBtnReal) goHomeBtnReal.addEventListener('click', () => {
                window.location.href = "https://sites.google.com/d/1d-yfXv38ngv2G48bn9-cW35WulOmJJX3/p/1CL9vI1Uc9Gqs3iP1Uf8TLcDP7imaLH9H/edit";
            });

            // Global click listener to close tooltips when clicking outside
            document.addEventListener('click', function(event) {
                // Get all currently active tooltips
                const activeJobItems = document.querySelectorAll('.job-item.active-tooltip');

                activeJobItems.forEach(item => {
                    // Check if the clicked element is NOT inside the current active job item
                    // and NOT the job item itself
                    if (!item.contains(event.target) && !item.isSameNode(event.target)) {
                        item.classList.remove('active-tooltip');
                    }
                });
            });
        });


        // --- Job Data ---
        // This data has been meticulously extracted and structured from the provided PDF.
        // Each object represents a job, with details for matching and display.
        const jobData = [
            {
                title: "ASSISTANT ENGINEER II (IRRIGATION)",
                levels: ["Degree"],
                courses: ["Agricultural Engineering", "Agricultural and Bio-Systems Engineering", "Soil Water and Environmental Engineering", "Environmental and Bio-Systems Engineering", "Biomechanical and Processing Engineering", "Soil and Water Engineering"],
                posts: "7 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "IRRIGATION WATER MANAGEMENT OFFICER II",
                levels: ["Degree"],
                courses: ["Agriculture", "Horticulture", "Agronomy", "Agricultural Economics", "Agribusiness", "Agricultural Resource Management"],
                posts: "1 vacancy",
                salaryMax: 46120,
                allowanceMax: 10000 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "LAND RECLAMATION OFFICER II",
                levels: ["Degree"],
                courses: ["Natural Resource Management", "Geography", "Economics", "Community Development", "Environmental Science"],
                posts: "1 vacancy",
                salaryMax: 46120,
                allowanceMax: 10000 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "IRRIGATION DEVELOPMENT CO-ORDINATION OFFICER II",
                levels: ["Degree"],
                courses: ["Agri Economics", "General Agriculture", "Economics", "Commerce", "Agri Business", "Agricultural Engineering", "Water Resource Management", "Agricultural and Bio-systems Engineering", "Soil Water and Environmental Engineering", "Environmental and Bio-systems Engineering", "Biomechanical and Processing Processing", "Soil and Water Engineering"],
                posts: "1 vacancy",
                salaryMax: 46120,
                allowanceMax: 10000 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "ASSISTANT IRRIGATION QUALITY ASSURANCE AND LICENCING OFFICER III",
                levels: ["Degree"],
                courses: ["Range Management", "Water Resource Management", "Irrigation", "Agriculture", "Environmental Resource Management", "Agricultural Engineering", "Water Engineering", "Civil Engineering", "Irrigation and Drainage", "Community Development"],
                posts: "5 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "ASSISTANT LAND RECLAMATION OFFICER III",
                levels: ["Degree"],
                courses: ["Range Management", "Water Resource Management", "Irrigation", "Forestry", "Agriculture", "Environmental Resource Management", "Earth Science", "Agricultural Engineering", "Chemical Engineering", "Water Engineering", "Civil Engineering", "Community Development"],
                posts: "4 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "LAND REGISTRAR II",
                levels: ["Degree"],
                courses: ["Law", "Land Economics", "Land Survey"],
                posts: "2 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "PHOTOLITHOGRAPHER II",
                levels: ["Degree"],
                courses: ["Technology in Printing", "Philosophy in Technology Printing", "Graphic Design", "Print Media"],
                posts: "6 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "HYDROGRAPHER II",
                levels: ["Degree"],
                courses: ["Geomatics Engineering and Geospatial Information Systems", "Hydrographic Survey"],
                posts: "4 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "PHOTOGRAMMETRIST II",
                levels: ["Degree"],
                courses: ["Geospatial Engineering", "Philosophy in Technology (Geo information)", "Technology in Geo-information"],
                posts: "5 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "LAND ADJUDICATION AND SETTLEMENT OFFICER II",
                levels: ["Degree"],
                courses: ["Geography", "Agriculture and Human Ecology Extension", "Agriculture and Home Economics", "Sociology", "Community Development"],
                posts: "15 vacancies",
                salaryMax: 46120,
                allowanceMax: 10000 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "LAND ADMINISTRATION ASSISTANT III",
                levels: ["Diploma", "Certificate"],
                courses: ["Land Administration", "Real Estate Agency"],
                posts: "1 vacancy",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Entry Level (Requires Diploma or equivalent qualification)",
                deadline: "8/7/2025",
            },
            {
                title: "PHYSICAL PLANNING ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Urban and Regional Planning", "Regional Planning", "Urban Planning", "Building", "Civil Engineering", "Cartography", "Geo-informatics", "Geographical Information Systems (GIS)"],
                posts: "15 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "PHOTOLITHOGRAPHIC ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Printing", "Map Reproduction"],
                posts: "6 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "HYDROGRAPHIC ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Hydrographic Surveying", "Land Surveying"],
                posts: "4 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "PHOTOGRAMMETRY ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Photogrammetry and Remote Sensing"],
                posts: "5 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "CARTOGRAPHY ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Cartography"],
                posts: "15 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "GEOSPATIAL DATA MANAGEMENT ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Archives and Records Management"],
                posts: "5 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "ARCHITECT",
                levels: ["Degree"],
                courses: ["Architecture"],
                posts: "16 vacancies",
                salaryMax: 65860,
                allowanceMax: 28000 + 6000,
                experienceReq: "Entry Level (Requires Graduate Membership)",
                deadline: "8/7/2025",
            },
            {
                title: "LANDSCAPE ARCHITECT II",
                levels: ["Degree"],
                courses: ["Landscape Architecture"],
                posts: "5 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Graduate Membership)",
                deadline: "8/7/2025",
            },
            {
                title: "ARCHITECTURAL ASSISTANT III",
                levels: ["Diploma", "Certificate"],
                courses: ["Building/Civil Engineering", "Architecture", "Technician Certificate Part III in Building/Civil Engineering", "Technician Certificate Part III in Architecture"],
                posts: "15 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Technician Certificate Part III in Building/Civil Engineering or Architecture",
                deadline: "8/7/2025",
            },
            {
                title: "INSPECTOR (BUILDINGS)",
                levels: ["Technician", "Certificate"],
                courses: ["Building Technology", "Civil Engineering", "Construction Technician Part III"],
                posts: "10 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Construction Technician Part III",
                deadline: "8/7/2025",
            },
            {
                title: "ENGINEER II (ELECTRICAL)",
                levels: ["Degree"],
                courses: ["Electrical Engineering"],
                posts: "28 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "INSPECTOR ELECTRICAL (BS)",
                levels: ["Technician", "Certificate"],
                courses: ["Electrical Engineering", "Electrical Technician Certificate Part III"],
                posts: "21 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Electrical Technician Certificate Part III",
                deadline: "8/7/2025",
            },
            {
                title: "INSPECTOR (ELECTRONICS)",
                levels: ["Technician", "Certificate"],
                courses: ["Electronics Engineering", "Electronics Technician Certificate Part III"],
                posts: "10 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Electronics Technician Certificate Part III",
                deadline: "8/7/2025",
            },
            {
                title: "ENGINEER II (MECHANICAL - BS)",
                levels: ["Degree"],
                courses: ["Mechanical Engineering"],
                posts: "25 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "INSPECTOR (MECHANICAL - BS)",
                levels: ["Technician", "Certificate"],
                courses: ["Mechanical Engineering", "Mechanical Technician Certificate part III"],
                posts: "15 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Mechanical Technician Certificate Part III",
                deadline: "8/7/2025",
            },
            {
                title: "FIRE OFFICER II",
                levels: ["Degree"],
                courses: ["Electrical Engineering", "Mechanical Engineering", "Chemical Engineering", "Mechatronics Engineering"],
                posts: "4 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "INSPECTOR II (FIRE SERVICES)",
                levels: ["Diploma", "Certificate"],
                courses: ["Mechanical Engineering", "Electrical Engineering", "Chemical Engineering", "First Aid Certificate"],
                posts: "10 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Diploma or equivalent qualification (plus First Aid Certificate)",
                deadline: "8/7/2025",
            },
            {
                title: "QUANTITY SURVEYOR II",
                levels: ["Degree"],
                courses: ["Building Economics", "Quantity Surveying"],
                posts: "27 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Graduate Membership)",
                deadline: "8/7/2025",
            },
            {
                title: "QUANTITY SURVEY ASSISTANT III",
                levels: ["Diploma", "Certificate"],
                courses: ["Quantity Survey", "Building/Civil Engineering"],
                posts: "20 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Diploma or equivalent qualification (may include technician equivalent qualification)",
                deadline: "8/7/2025",
            },
            {
                title: "ENGINEER II (STRUCTURAL)",
                levels: ["Degree"],
                courses: ["Civil Engineering"],
                posts: "28 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "STRUCTURAL ASSISTANT III",
                levels: ["Diploma", "Certificate"],
                courses: ["Civil Engineering", "Building", "Construction Technician Certificate Part III"],
                posts: "18 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Diploma or equivalent qualification (Construction Technician Certificate Part III or equivalent)",
                deadline: "8/7/2025",
            },
            {
                title: "DESIGNER II",
                levels: ["Degree"],
                courses: ["Interior Design"],
                posts: "12 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Association Registration)",
                deadline: "8/7/2025",
            },
            {
                title: "DESIGN ASSISTANT III",
                levels: ["Diploma"],
                courses: ["Interior Design"],
                posts: "6 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "RESEARCH OFFICER",
                levels: ["Degree"],
                courses: ["Construction/Project Management", "Architecture", "Economics", "Building Economics", "Quantity Surveying", "Urban Planning", "Statistics", "Sociology", "Geography"],
                posts: "2 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "CHIEF BUILDING INSPECTION AND AUDIT OFFICER",
                levels: ["Degree"],
                courses: ["Architecture", "Mechanical Engineering", "Structural Engineering", "Electrical Engineering", "Civil Engineering", "Quantity Survey", "Design", "Urban and Regional Planning", "Building Economics", "Construction Management"],
                posts: "5 vacancies",
                salaryMax: 65860,
                allowanceMax: 28000 + 6000,
                experienceReq: "Experience required (Member of professional body)",
                deadline: "8/7/2025",
            },
            {
                title: "SENIOR BUILDING SAFETY, TESTING & QUALITY ASSURANCE OFFICER",
                levels: ["Degree"],
                courses: ["Architecture", "Mechanical Engineering", "Structural Engineering", "Electrical Engineering", "Civil Engineering", "Quantity Survey", "Design", "Building Economics", "Construction Management"],
                posts: "3 vacancies",
                salaryMax: 65860,
                allowanceMax: 28000 + 6000,
                experienceReq: "Experience required",
                deadline: "8/7/2025",
            },
            {
                title: "ENFORCEMENT OFFICER",
                levels: ["Degree"],
                courses: ["Public Policy and Administration", "Security", "Law", "Sociology", "Anthropology", "Construction Management"],
                posts: "2 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Experience required (Member of professional body)",
                deadline: "8/7/2025",
            },
            {
                title: "MECHANICAL ENGINEER II (MECHANICAL AND TRANSPORT)",
                levels: ["Degree"],
                courses: ["Mechanical Engineering", "Mechanical & Production Engineering", "Mechatronics Engineering", "Mechanical & Industrial Engineering", "Mechanical & Manufacturing Engineering"],
                posts: "7 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree in Engineering)",
                deadline: "8/7/2025",
            },
            {
                title: "LECTURER II (KIHBT)",
                levels: ["Degree"],
                courses: ["Civil Engineering", "Electrical/Electronic Engineering", "Mechanical Engineering", "Geospatial Engineering", "Quantity Surveying", "Mechatronics Engineering", "Architecture", "Construction Management"],
                posts: "14 vacancies",
                salaryMax: 57230,
                allowanceMax: 16500 + 5000,
                experienceReq: "Entry Level (Requires Bachelor's Degree)",
                deadline: "8/7/2025",
            },
            {
                title: "INSTRUCTOR III (KIHBT)",
                levels: ["Certificate", "Technician"],
                courses: ["Electronics Engineering", "Electrical Engineering", "Mechanical Engineering", "Automotive Engineering", "Construction Plant Engineering", "Civil Engineering", "Highway Engineering", "Building Construction", "Land Surveying", "Quantity Surveying", "Architecture", "Construction Management", "Instructor Training", "Training of Trainers", "Technician II (KNEC) Certificate", "Technician III (KNEC) Certificate"],
                posts: "15 vacancies",
                salaryMax: 37100,
                allowanceMax: 6750 + 4000,
                experienceReq: "Requires Technician II and III (KNEC) Certificate",
                deadline: "8/7/2025",
            },
            {
                title: "SENIOR PRINCIPAL LABORATORY TECHNOLOGIST",
                levels: ["Higher Diploma"],
                courses: ["Applied Sciences (Chemistry)", "Applied Sciences (Analytical Chemistry)", "Applied Sciences (Industrial Chemistry)", "Applied Sciences (Biology)", "Food Science and Technology", "Medical Laboratory Technology", "Building/Civil Engineering", "Earth Sciences Biotechnology", "Environmental Chemistry", "Microbiology", "Parasitology", "Hematology", "Histology and Cytology", "Construction Management"],
                posts: "1 vacancy",
                salaryMax: 133410,
                allowanceMax: 45000 + 12000,
                experienceReq: "Experience required",
                deadline: "8/7/2025",
            },
            {
                title: "ASSISTANT DIRECTOR LABORATORY SERVICES",
                levels: ["Degree"],
                courses: ["Laboratory Sciences", "Biomedical Sciences", "Medical Laboratory Technology", "Biotechnology", "Applied Biology", "Biochemistry", "Analytical/Applied Chemistry", "Microbiology", "Food Science and Technology", "Civil Engineering", "Construction Management"],
                posts: "1 vacancy",
                salaryMax: 133410,
                allowanceMax: 45000 + 12000,
                experienceReq: "Experience required",
                deadline: "8/7/2025",
            },
            {
                title: "SENIOR PRINCIPAL LECTURER, KISM",
                levels: ["Degree"],
                courses: ["Land Surveying", "Geomatics", "Geomatics Engineering", "Technology in Geomatics", "Geo-informatics", "Cartography", "Remote Sensing", "Photogrammetry", "Geographical Information Systems (GIS)", "Physics", "Chemistry", "Geography", "Mathematics", "Computer Science", "Information and Communication Technology (ICT) Entrepreneurship", "Print Media Management", "Printing Technology", "Education", "Construction Management", "Training of Trainers Certificate", "Instructor Training Certificate"],
                posts: "5 vacancies",
                salaryMax: 133410,
                allowanceMax: 45000 + 12000,
                experienceReq: "Experience required (Training of Trainers Certificate)",
                deadline: "8/7/2025",
            },
            {
                title: "Construction Technician",
                levels: ["Technician"],
                courses: ["Construction Technology", "Building Construction", "Construction Management"],
                posts: "Multiple vacancies",
                salaryMax: 35000,
                allowanceMax: 6000 + 3000,
                experienceReq: "No experience required (Entry Level)",
                deadline: "8/7/2025",
            },
            {
                title: "Construction Manager",
                levels: ["Degree"],
                courses: ["Construction Management", "Civil Engineering", "Building Economics", "Project Management"],
                posts: "Multiple vacancies",
                salaryMax: 65860,
                allowanceMax: 28000 + 6000,
                experienceReq: "Experience required",
                deadline: "8/7/2025",
            }
        ];

        // --- Utility Functions ---

        // Levenshtein Distance function for fuzzy matching
        // Source: https://en.wikipedia.org/wiki/Levenshtein_distance#Iterative_with_full_matrix
        function levenshteinDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();

            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) {
                    costs[s2.length] = lastValue;
                }
            }
            return costs[s2.length];
        }

        // --- Firebase Data Fetching and Display ---
        // Removed listenForRegisteredUsers and fetchAndDisplayRegisteredUsers
        // as the admin view and its associated functionality are removed.

        // --- Main Logic ---
        function findJobs() {
            // Use the inputs from the real jobs page
            const selectedLevel = realQualificationLevelSelect.value;
            let enteredCourse = realCourseNameInput.value.trim().toLowerCase();

            jobListDiv.innerHTML = ''; // Clear previous results

            if (!selectedLevel || !enteredCourse) {
                jobListDiv.innerHTML = '<p class="text-red-500 text-center">Please select a qualification level and enter your course name.</p>';
                return;
            }

            const constructionManagementSynonyms = ["management", "construction", "construction management"];
            if (constructionManagementSynonyms.includes(enteredCourse)) {
                enteredCourse = "construction/project management";
            }

            const primaryMatchingJobs = [];
            const threshold = 3;

            jobData.forEach(job => {
                if (job.levels.includes(selectedLevel)) {
                    let courseMatched = false;
                    for (const course of job.courses) {
                        const normalizedCourse = course.toLowerCase();
                        if (normalizedCourse.includes(enteredCourse) || enteredCourse.includes(normalizedCourse) || levenshteinDistance(enteredCourse, normalizedCourse) <= threshold) {
                            courseMatched = true;
                            break;
                        }
                    }
                    if (courseMatched) {
                        primaryMatchingJobs.push(job);
                    }
                }
            });

            if (primaryMatchingJobs.length > 0) {
                displayJobs(primaryMatchingJobs, false);
            } else {
                const closestJobs = [];
                jobData.forEach(job => {
                    if (job.levels.includes("Certificate") || job.levels.includes("Technician")) {
                        let courseMatched = false;
                        for (const course of job.courses) {
                            const normalizedCourse = course.toLowerCase();
                            if (normalizedCourse.includes(enteredCourse) || enteredCourse.includes(normalizedCourse) || levenshteinDistance(enteredCourse, normalizedCourse) <= 4) {
                                courseMatched = true;
                                break;
                            }
                        }
                        if (courseMatched) {
                            closestJobs.push(job);
                        }
                    }
                });

                if (closestJobs.length > 0) {
                    displayJobs(closestJobs, true);
                } else {
                    jobListDiv.innerHTML = '<p class="text-gray-500 text-center">No jobs found for your criteria. Try a different course or qualification level.</p>';
                }
            }
        }

        function displayJobs(jobs, isClosestMatch) {
            if (jobs.length === 0) {
                jobListDiv.innerHTML = '<p class="text-gray-500 text-center">No jobs found for your criteria. Try a different course or qualification level.</p>';
                return;
            }

            jobListDiv.innerHTML = '';
            if (isClosestMatch) {
                jobListDiv.innerHTML += '<p class="text-gray-700 text-center mb-4">No direct matches found. Here are some closest jobs you can try:</p>';
            }

            const specificRequirementTitles = [
                "INSPECTOR (BUILDINGS)",
                "INSPECTOR ELECTRICAL (BS)",
                "INSPECTOR (MECHANICAL - BS)",
                "INSPECTOR (ELECTRONICS)",
                "INSPECTOR II (FIRE SERVICES)",
                "ARCHITECTURAL ASSISTANT III",
                "STRUCTURAL ASSISTANT III",
                "QUANTITY SURVEY ASSISTANT III",
                "INSTRUCTOR III (KIHBT)",
                "LAND ADMINISTRATION ASSISTANT III"
            ];

            jobs.forEach((job, index) => {
                const jobItem = document.createElement('div');
                jobItem.className = 'job-item';
                // Apply animation with a staggered delay
                jobItem.style.animationDelay = `${index * 0.1}s`;
                jobItem.classList.add('fade-in-slide-up');


                let postsFormatted = '';
                if (job.posts !== "Not specified" && job.posts !== "Multiple vacancies") {
                    postsFormatted = job.posts.replace(/(\d+)/g, '<span class="font-bold text-lime-300">$1</span>');
                    postsFormatted = postsFormatted.replace('vacancies', 'vacancies, ');
                } else if (job.posts === "Multiple vacancies") {
                    postsFormatted = `<span class="font-bold text-lime-300">Multiple vacancies</span>, `;
                } else {
                    postsFormatted = `Not specified, `;
                }

                let qualificationDisplay = '';
                if (specificRequirementTitles.includes(job.title)) {
                    // Display the experienceReq directly for specified titles
                    qualificationDisplay = job.experienceReq;
                } else {
                    // For other jobs, display "Qualification: [Level(s)]"
                    qualificationDisplay = `Qualification: ${job.levels.join(', ')}`;
                }

                let conciseSummary = `
                    ${postsFormatted}
                    <span class="font-bold text-lime-300">Salary:</span> upto Kshs. ${job.salaryMax.toLocaleString()} pm,
                    <span class="font-bold text-lime-300">Allowance:</span> upto Ksh ${job.allowanceMax.toLocaleString()} pm,
                    <span class="font-bold text-lime-300">Experience:</span> ${job.experienceReq},
                    <span class="font-bold text-lime-300">Deadline:</span> ${job.deadline},
                    <span class="font-bold text-lime-300">Info:</span> Job available in GoK website, just google <a href="https://www.psckjobs.go.ke/loginPage.aspx" target="_blank" class="text-blue-400 hover:underline">PSC</a> jobs.
                `.replace(/\s+/g, ' ').trim();

                if (isClosestMatch) {
                    conciseSummary += `<br><br><span class="font-bold text-yellow-300">These are closest that you can try.</span>`;
                }

                jobItem.innerHTML = `
                    <h3 class="text-lg">${job.title}</h3>
                    <p class="text-sm text-gray-600">${qualificationDisplay}</p>
                    <div class="info-hint">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Details</span>
                    </div>
                    <div class="tooltip">
                        ${conciseSummary}
                    </div>
                `;
                jobListDiv.appendChild(jobItem);

                // Add click listener to job item for tooltip toggle
                jobItem.addEventListener('click', function(event) {
                    // Prevent click from propagating to the body listener immediately
                    event.stopPropagation();

                    // Close any other open tooltips first
                    document.querySelectorAll('.job-item.active-tooltip').forEach(item => {
                        if (item !== jobItem) { // Don't close the current one if it's already open
                            item.classList.remove('active-tooltip');
                        }
                    });

                    // Toggle the 'active-tooltip' class on the clicked job item
                    // This will now close it if it's already open, or open it if it's closed.
                    jobItem.classList.toggle('active-tooltip');
                });
            });
        }
    </script>
</body>
</html>
